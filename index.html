<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Manager Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-gray-600">Loading from Firebase...</p>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBwqkoiPx6nWU5Gv8WWc7P_Qu8_RsxhRF8",
            authDomain: "account-manager-dashboar-18a39.firebaseapp.com",
            databaseURL: "https://account-manager-dashboar-18a39-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "account-manager-dashboar-18a39",
            storageBucket: "account-manager-dashboar-18a39.firebasestorage.app",
            messagingSenderId: "494866550687",
            appId: "1:494866550687:web:efaa3ffb794748510877aa"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Initial Data
        const initialData = {
            settings: { maxClients: 3, maxVideos: 540 },
            managers: [
                { id: 1, name: 'Account Manager 1', clients: [
                    { id: 1, name: 'Client A', videos: 180 },
                    { id: 2, name: 'Client B', videos: 120 }
                ]},
                { id: 2, name: 'Account Manager 2', clients: [
                    { id: 3, name: 'Client C', videos: 90 },
                    { id: 4, name: 'Client D', videos: 90 },
                    { id: 5, name: 'Client E', videos: 60 }
                ]},
                { id: 3, name: 'Account Manager 3', clients: [
                    { id: 6, name: 'Client F', videos: 180 },
                    { id: 7, name: 'Client G', videos: 150 }
                ]},
                { id: 4, name: 'Account Manager 4', clients: [
                    { id: 8, name: 'Client H', videos: 90 }
                ]},
                { id: 5, name: 'Account Manager 5', clients: [] }
            ]
        };

        // Global State
        let data = { settings: {}, managers: [], syncing: false, editingId: null, addingTo: null };
        let isDrawing = false;

        // Save to Firebase (no redraw!)
        function save() {
            data.syncing = true;
            updateSyncStatus();
            
            Promise.all([
                db.ref('settings').set(data.settings),
                db.ref('managers').set(data.managers)
            ]).then(() => {
                setTimeout(() => { 
                    data.syncing = false; 
                    updateSyncStatus();
                }, 500);
            }).catch(err => {
                console.error('Save error:', err);
                data.syncing = false;
                updateSyncStatus();
            });
        }

        function updateSyncStatus() {
            const statusEl = document.getElementById('sync-status');
            if (statusEl) {
                statusEl.innerHTML = data.syncing ? 
                    '<div class="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div><span class="text-blue-600">Syncing...</span>' :
                    '<span class="text-green-600">✓ Saved</span>';
            }
        }

        // Load from Firebase ONCE - NO LISTENERS
        Promise.all([
            db.ref('settings').once('value'),
            db.ref('managers').once('value')
        ]).then(([settingsSnap, managersSnap]) => {
            // Load settings
            if (settingsSnap.exists()) {
                data.settings = settingsSnap.val();
            } else {
                data.settings = initialData.settings;
                db.ref('settings').set(data.settings);
            }

            // Load managers
            if (managersSnap.exists()) {
                let managersData = managersSnap.val();
                
                // If Firebase converted array to object, convert it back
                if (!Array.isArray(managersData) && typeof managersData === 'object') {
                    managersData = Object.values(managersData);
                }
                
                data.managers = managersData;
                
                // Fix any managers missing clients array or with object clients
                data.managers.forEach(mgr => {
                    if (!mgr.clients) {
                        mgr.clients = [];
                    } else if (!Array.isArray(mgr.clients) && typeof mgr.clients === 'object') {
                        // Convert object to array
                        mgr.clients = Object.values(mgr.clients);
                    }
                });
            } else {
                data.managers = initialData.managers;
                db.ref('managers').set(data.managers);
            }

            // Draw once and stop
            draw();
            console.log('Dashboard loaded successfully!');
        }).catch(err => {
            console.error('Load error:', err);
            alert('Error loading from Firebase: ' + err.message);
        });

        // Actions - GLOBAL FUNCTIONS
        function updateSetting(field, val) {
            data.settings[field] = parseInt(val) || 0;
            save();
        }

        function showAddForm(mgrId) {
            data.addingTo = mgrId;
            draw();
        }

        function cancelAdd() {
            data.addingTo = null;
            draw();
        }

        function addClient(mgrId) {
            const nameInput = document.getElementById(`name-${mgrId}`);
            const videosInput = document.getElementById(`videos-${mgrId}`);
            
            if (!nameInput || !videosInput) return;
            
            const name = nameInput.value.trim();
            const videos = parseInt(videosInput.value);
            
            if (!name || !videos) {
                alert('Please enter both name and videos');
                return;
            }
            
            const mgr = data.managers.find(m => m.id === mgrId);
            if (mgr) {
                mgr.clients.push({ id: Date.now(), name, videos });
                data.addingTo = null;
                draw();
                save();
            }
        }

        function removeClient(mgrId, clientId) {
            const mgr = data.managers.find(m => m.id === mgrId);
            if (mgr) {
                mgr.clients = mgr.clients.filter(c => c.id !== clientId);
                draw();
                save();
            }
        }

        function startEdit(mgrId) {
            data.editingId = mgrId;
            draw();
        }

        function renameManager(mgrId, newName) {
            if (!newName) return;
            const mgr = data.managers.find(m => m.id === mgrId);
            if (mgr) {
                mgr.name = newName;
                data.editingId = null;
                draw();
                save();
            }
        }

        // Calculate Capacity (with safety checks)
        function calcCap(mgr) {
            // Ensure clients array exists
            if (!mgr.clients || !Array.isArray(mgr.clients)) {
                mgr.clients = [];
            }
            
            const vids = mgr.clients.reduce((sum, c) => sum + (c.videos || 0), 0);
            const vidPct = (vids / data.settings.maxVideos) * 100;
            const cliPct = (mgr.clients.length / data.settings.maxClients) * 100;
            return {
                videos: vids,
                clients: mgr.clients.length,
                vidPct: Math.min(vidPct, 100),
                cliPct: Math.min(cliPct, 100),
                overall: Math.min(Math.max(vidPct, cliPct), 100)
            };
        }

        function getColor(pct) {
            return pct >= 90 ? 'red' : pct >= 70 ? 'yellow' : 'green';
        }

        function getBgClass(color) {
            return color === 'red' ? 'bg-red-500' : color === 'yellow' ? 'bg-yellow-500' : 'bg-green-500';
        }

        // Draw UI - ONLY when called manually
        function draw() {
            if (isDrawing) {
                console.log('Already drawing, skipping...');
                return;
            }
            isDrawing = true;

            const sorted = [...data.managers].sort((a, b) => 
                calcCap(a).overall - calcCap(b).overall
            );
            const best = sorted[0];

            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-8">
                    <div class="max-w-7xl mx-auto">
                        <!-- Header -->
                        <div class="flex justify-between items-center mb-8">
                            <div>
                                <h1 class="text-4xl font-bold text-gray-800">Account Manager Dashboard</h1>
                                <p class="text-gray-600 mt-1">Track capacity and optimize allocation</p>
                            </div>
                            <div id="sync-status" class="flex items-center gap-2 text-sm">
                                <span class="text-green-600">✓ Saved</span>
                            </div>
                        </div>

                        <!-- Settings -->
                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <h2 class="text-xl font-bold mb-4">Capacity Limits</h2>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Max Clients</label>
                                    <input type="number" value="${data.settings.maxClients}" 
                                        onchange="updateSetting('maxClients', this.value)"
                                        class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Max Videos/Month</label>
                                    <input type="number" value="${data.settings.maxVideos}"
                                        onchange="updateSetting('maxVideos', this.value)"
                                        class="w-full px-4 py-2 border rounded-lg">
                                </div>
                            </div>
                        </div>

                        <!-- Recommendation -->
                        <div class="bg-blue-600 text-white rounded-lg shadow p-6 mb-6">
                            <h2 class="text-xl font-bold mb-2">📋 Next Assignment</h2>
                            <p class="text-lg">Give next client to: <strong>${best.name}</strong></p>
                            <p class="text-sm opacity-90 mt-1">Current load: ${calcCap(best).overall.toFixed(0)}%</p>
                        </div>

                        <!-- Managers Grid -->
                        <div class="grid lg:grid-cols-2 gap-6">
                            ${data.managers.map(mgr => {
                                const cap = calcCap(mgr);
                                const color = getColor(cap.overall);
                                const bgClass = getBgClass(color);
                                
                                return `
                                    <div class="bg-white rounded-lg shadow overflow-hidden">
                                        <!-- Header -->
                                        <div class="${bgClass} text-white p-4">
                                            <div class="flex justify-between items-center">
                                                <div class="flex items-center gap-3">
                                                    ${color === 'green' ? '✅' : color === 'yellow' ? '⚠️' : '🚨'}
                                                    ${data.editingId === mgr.id ? 
                                                        `<input type="text" value="${mgr.name}" 
                                                            onblur="renameManager(${mgr.id}, this.value)"
                                                            onkeypress="if(event.key==='Enter') renameManager(${mgr.id}, this.value)"
                                                            class="bg-white text-black px-2 py-1 rounded" autofocus>` :
                                                        `<h3 class="text-xl font-bold">${mgr.name}</h3>`
                                                    }
                                                    <button onclick="startEdit(${mgr.id})" class="hover:bg-white/20 p-1 rounded text-xl">✏️</button>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-3xl font-bold">${cap.overall.toFixed(0)}%</div>
                                                    <div class="text-sm opacity-90">Used</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Stats -->
                                        <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50">
                                            <div>
                                                <div class="text-sm text-gray-600">Clients</div>
                                                <div class="text-2xl font-bold">${cap.clients} / ${data.settings.maxClients}</div>
                                                <div class="mt-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                    <div class="${getBgClass(getColor(cap.cliPct))} h-full" style="width:${cap.cliPct}%"></div>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="text-sm text-gray-600">Videos</div>
                                                <div class="text-2xl font-bold">${cap.videos} / ${data.settings.maxVideos}</div>
                                                <div class="mt-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                    <div class="${getBgClass(getColor(cap.vidPct))} h-full" style="width:${cap.vidPct}%"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Clients -->
                                        <div class="p-4">
                                            <h4 class="font-bold mb-3">Clients</h4>
                                            ${mgr.clients.length === 0 ? 
                                                '<p class="text-gray-400 italic text-sm">No clients yet</p>' :
                                                `<div class="space-y-2 mb-3">
                                                    ${mgr.clients.map(c => `
                                                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded">
                                                            <div>
                                                                <div class="font-medium">${c.name}</div>
                                                                <div class="text-sm text-gray-600">${c.videos} videos/mo</div>
                                                            </div>
                                                            <button onclick="removeClient(${mgr.id}, ${c.id})"
                                                                class="text-red-500 hover:bg-red-50 p-2 rounded text-xl">🗑️</button>
                                                        </div>
                                                    `).join('')}
                                                </div>`
                                            }

                                            <!-- Add Client Form -->
                                            ${data.addingTo === mgr.id ? `
                                                <div class="bg-blue-50 p-3 rounded space-y-2">
                                                    <input type="text" id="name-${mgr.id}" placeholder="Client name" 
                                                        class="w-full px-3 py-2 border rounded-lg">
                                                    <input type="number" id="videos-${mgr.id}" placeholder="Videos/month"
                                                        class="w-full px-3 py-2 border rounded-lg">
                                                    <div class="flex gap-2">
                                                        <button onclick="addClient(${mgr.id})"
                                                            class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-medium">
                                                            Add Client
                                                        </button>
                                                        <button onclick="cancelAdd()"
                                                            class="px-4 py-2 border rounded-lg hover:bg-gray-100">
                                                            Cancel
                                                        </button>
                                                    </div>
                                                </div>
                                            ` : `
                                                <button onclick="showAddForm(${mgr.id})"
                                                    class="w-full py-2 border-2 border-dashed rounded-lg hover:border-blue-500 hover:text-blue-600 font-medium">
                                                    + Add Client
                                                </button>
                                            `}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;

            isDrawing = false;
        }
    </script>

    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</body>
</html>
