<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Manager Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';

        // Your Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBwqkoiPx6nWU5Gv8WWc7P_Qu8_RsxhRF8",
            authDomain: "account-manager-dashboar-18a39.firebaseapp.com",
            databaseURL: "https://account-manager-dashboar-18a39-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "account-manager-dashboar-18a39",
            storageBucket: "account-manager-dashboar-18a39.firebasestorage.app",
            messagingSenderId: "494866550687",
            appId: "1:494866550687:web:efaa3ffb794748510877aa"
        };

        // Initialize
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Initial Data
        const initialData = {
            settings: { maxClients: 3, maxVideos: 540 },
            managers: [
                { id: 1, name: 'Account Manager 1', clients: [
                    { id: 1, name: 'Client A', videos: 180 },
                    { id: 2, name: 'Client B', videos: 120 }
                ]},
                { id: 2, name: 'Account Manager 2', clients: [
                    { id: 3, name: 'Client C', videos: 90 },
                    { id: 4, name: 'Client D', videos: 90 },
                    { id: 5, name: 'Client E', videos: 60 }
                ]},
                { id: 3, name: 'Account Manager 3', clients: [
                    { id: 6, name: 'Client F', videos: 180 },
                    { id: 7, name: 'Client G', videos: 150 }
                ]},
                { id: 4, name: 'Account Manager 4', clients: [
                    { id: 8, name: 'Client H', videos: 90 }
                ]},
                { id: 5, name: 'Account Manager 5', clients: [] }
            ]
        };

        // Global State
        let data = { ...initialData, syncing: false, editingId: null, addingTo: null };

        // Save to Firebase
        function save() {
            data.syncing = true;
            draw();
            Promise.all([
                set(ref(db, 'settings'), data.settings),
                set(ref(db, 'managers'), data.managers)
            ]).then(() => {
                setTimeout(() => { data.syncing = false; draw(); }, 300);
            });
        }

        // Load from Firebase
        onValue(ref(db, 'settings'), (snap) => {
            if (snap.exists()) {
                data.settings = snap.val();
                draw();
            } else {
                set(ref(db, 'settings'), initialData.settings);
            }
        });

        onValue(ref(db, 'managers'), (snap) => {
            if (snap.exists()) {
                data.managers = snap.val();
                draw();
            } else {
                set(ref(db, 'managers'), initialData.managers);
            }
        });

        // Calculate Capacity
        function calcCap(mgr) {
            const vids = mgr.clients.reduce((sum, c) => sum + c.videos, 0);
            const vidPct = (vids / data.settings.maxVideos) * 100;
            const cliPct = (mgr.clients.length / data.settings.maxClients) * 100;
            return {
                videos: vids,
                clients: mgr.clients.length,
                vidPct: Math.min(vidPct, 100),
                cliPct: Math.min(cliPct, 100),
                overall: Math.min(Math.max(vidPct, cliPct), 100)
            };
        }

        function getColor(pct) {
            return pct >= 90 ? 'red' : pct >= 70 ? 'yellow' : 'green';
        }

        function getBgClass(color) {
            return color === 'red' ? 'bg-red-500' : color === 'yellow' ? 'bg-yellow-500' : 'bg-green-500';
        }

        // Actions - Make them global
        const actions = {
            updateSetting: (field, val) => {
                data.settings[field] = parseInt(val) || 0;
                save();
            },

            addClient: (mgrId, name, videos) => {
                const mgr = data.managers.find(m => m.id === mgrId);
                if (mgr && name && videos) {
                    mgr.clients.push({ id: Date.now(), name, videos: parseInt(videos) });
                    data.addingTo = null;
                    save();
                }
            },

            removeClient: (mgrId, clientId) => {
                const mgr = data.managers.find(m => m.id === mgrId);
                if (mgr) {
                    mgr.clients = mgr.clients.filter(c => c.id !== clientId);
                    save();
                }
            },

            renameManager: (mgrId, newName) => {
                const mgr = data.managers.find(m => m.id === mgrId);
                if (mgr && newName) {
                    mgr.name = newName;
                    data.editingId = null;
                    save();
                }
            },

            showAddForm: (mgrId) => {
                data.addingTo = mgrId;
                draw();
            },

            cancelAdd: () => {
                data.addingTo = null;
                draw();
            },

            startEdit: (mgrId) => {
                data.editingId = mgrId;
                draw();
            }
        };

        // Expose to window
        Object.assign(window, actions);

        // Draw UI
        function draw() {
            const best = data.managers.sort((a, b) => 
                calcCap(a).overall - calcCap(b).overall
            )[0];

            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-8">
                    <div class="max-w-7xl mx-auto">
                        <!-- Header -->
                        <div class="flex justify-between items-center mb-8">
                            <div>
                                <h1 class="text-4xl font-bold text-gray-800">Account Manager Dashboard</h1>
                                <p class="text-gray-600 mt-1">Track capacity and optimize allocation</p>
                            </div>
                            <div class="flex items-center gap-2 text-sm">
                                ${data.syncing ? 
                                    '<div class="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div><span class="text-blue-600">Syncing...</span>' :
                                    '<svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4"/></svg><span class="text-green-600">Saved</span>'
                                }
                            </div>
                        </div>

                        <!-- Settings -->
                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <h2 class="text-xl font-bold mb-4">Capacity Limits</h2>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Max Clients</label>
                                    <input type="number" value="${data.settings.maxClients}" 
                                        onchange="updateSetting('maxClients', this.value)"
                                        class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Max Videos/Month</label>
                                    <input type="number" value="${data.settings.maxVideos}"
                                        onchange="updateSetting('maxVideos', this.value)"
                                        class="w-full px-4 py-2 border rounded-lg">
                                </div>
                            </div>
                        </div>

                        <!-- Recommendation -->
                        <div class="bg-blue-600 text-white rounded-lg shadow p-6 mb-6">
                            <h2 class="text-xl font-bold mb-2">üìã Next Assignment</h2>
                            <p class="text-lg">Give next client to: <strong>${best.name}</strong></p>
                            <p class="text-sm opacity-90 mt-1">Current load: ${calcCap(best).overall.toFixed(0)}%</p>
                        </div>

                        <!-- Managers Grid -->
                        <div class="grid lg:grid-cols-2 gap-6">
                            ${data.managers.map(mgr => {
                                const cap = calcCap(mgr);
                                const color = getColor(cap.overall);
                                const bgClass = getBgClass(color);
                                
                                return `
                                    <div class="bg-white rounded-lg shadow overflow-hidden">
                                        <!-- Header -->
                                        <div class="${bgClass} text-white p-4">
                                            <div class="flex justify-between items-center">
                                                <div class="flex items-center gap-3">
                                                    ${color === 'green' ? '‚úÖ' : color === 'yellow' ? '‚ö†Ô∏è' : 'üö®'}
                                                    ${data.editingId === mgr.id ? 
                                                        `<input type="text" value="${mgr.name}" 
                                                            onblur="renameManager(${mgr.id}, this.value)"
                                                            onkeypress="if(event.key==='Enter') renameManager(${mgr.id}, this.value)"
                                                            class="bg-white text-black px-2 py-1 rounded" autofocus>` :
                                                        `<h3 class="text-xl font-bold">${mgr.name}</h3>`
                                                    }
                                                    <button onclick="startEdit(${mgr.id})" class="hover:bg-white/20 p-1 rounded">‚úèÔ∏è</button>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-3xl font-bold">${cap.overall.toFixed(0)}%</div>
                                                    <div class="text-sm opacity-90">Used</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Stats -->
                                        <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50">
                                            <div>
                                                <div class="text-sm text-gray-600">Clients</div>
                                                <div class="text-2xl font-bold">${cap.clients} / ${data.settings.maxClients}</div>
                                                <div class="mt-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                    <div class="${getBgClass(getColor(cap.cliPct))} h-full" style="width:${cap.cliPct}%"></div>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="text-sm text-gray-600">Videos</div>
                                                <div class="text-2xl font-bold">${cap.videos} / ${data.settings.maxVideos}</div>
                                                <div class="mt-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                    <div class="${getBgClass(getColor(cap.vidPct))} h-full" style="width:${cap.vidPct}%"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Clients -->
                                        <div class="p-4">
                                            <h4 class="font-bold mb-3">Clients</h4>
                                            ${mgr.clients.length === 0 ? 
                                                '<p class="text-gray-400 italic text-sm">No clients yet</p>' :
                                                `<div class="space-y-2 mb-3">
                                                    ${mgr.clients.map(c => `
                                                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded">
                                                            <div>
                                                                <div class="font-medium">${c.name}</div>
                                                                <div class="text-sm text-gray-600">${c.videos} videos/mo</div>
                                                            </div>
                                                            <button onclick="removeClient(${mgr.id}, ${c.id})" 
                                                                class="text-red-500 hover:bg-red-50 p-2 rounded">üóëÔ∏è</button>
                                                        </div>
                                                    `).join('')}
                                                </div>`
                                            }

                                            <!-- Add Client Form -->
                                            ${data.addingTo === mgr.id ? `
                                                <div class="bg-blue-50 p-3 rounded space-y-2">
                                                    <input type="text" id="clientName${mgr.id}" placeholder="Client name" 
                                                        class="w-full px-3 py-2 border rounded">
                                                    <input type="number" id="clientVideos${mgr.id}" placeholder="Videos/month"
                                                        class="w-full px-3 py-2 border rounded">
                                                    <div class="flex gap-2">
                                                        <button onclick="addClient(${mgr.id}, 
                                                            document.getElementById('clientName${mgr.id}').value,
                                                            document.getElementById('clientVideos${mgr.id}').value)"
                                                            class="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                                            Add
                                                        </button>
                                                        <button onclick="cancelAdd()" 
                                                            class="px-4 py-2 border rounded hover:bg-gray-100">
                                                            Cancel
                                                        </button>
                                                    </div>
                                                </div>
                                            ` : `
                                                <button onclick="showAddForm(${mgr.id})"
                                                    class="w-full py-2 border-2 border-dashed rounded hover:border-blue-500 hover:text-blue-600">
                                                    + Add Client
                                                </button>
                                            `}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Initial draw
        draw();
    </script>

    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</body>
</html>
